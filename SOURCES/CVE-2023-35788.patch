From 8398432d0089816088ce56033b35a1bf27e161c4 Mon Sep 17 00:00:00 2001
From: Ryan Sullivan <rysulliv@redhat.com>
Date: Wed, 12 Jul 2023 09:27:20 -0400
Subject: [KPATCH CVE-2023-35788] kpatch fixes for CVE-2023-35788

Kernels:
4.18.0-477.10.1.el8_8
4.18.0-477.13.1.el8_8
4.18.0-477.15.1.el8_8


Kpatch-MR: https://gitlab.com/redhat/prdsc/rhel/src/kpatch/rhel-8/-/merge_requests/115
Approved-by: Yannick Cote (@ycote1)
Approved-by: Joe Lawrence (@joe.lawrence)
Changes since last build:
[x86_64]:
cls_flower.o: changed function: fl_set_geneve_opt
cls_fw.o: changed function: fw_set_parms
ipvlan_core.o: changed function: ipvlan_process_v6_outbound
ipvlan_core.o: changed function: ipvlan_queue_xmit
nf_tables_api.o: changed function: nf_tables_bind_set
nf_tables_api.o: changed function: nf_tables_deactivate_flowtable
nf_tables_api.o: changed function: nf_tables_deactivate_set
nf_tables_api.o: changed function: nf_tables_newrule
nf_tables_api.o: new function: __nft_set_trans_bind
nft_byteorder.o: changed function: nft_byteorder_eval
nft_set_pipapo.o: changed function: nft_pipapo_remove

[ppc64le]:
cls_flower.o: changed function: fl_set_geneve_opt
cls_fw.o: changed function: fw_set_parms
ipvlan_core.o: changed function: ipvlan_process_v6_outbound
ipvlan_core.o: changed function: ipvlan_queue_xmit
nf_tables_api.o: changed function: nf_tables_deactivate_flowtable
nf_tables_api.o: changed function: nf_tables_deactivate_set
nf_tables_api.o: changed function: nf_tables_newrule
nft_byteorder.o: changed function: nft_byteorder_eval
nft_set_pipapo.o: changed function: nft_pipapo_remove

---------------------------

Modifications: none

commit 1e544b5c531dc3a862060dfdf528672693fc1ebb
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Tue Jun 20 10:23:10 2023 +0200

    net/sched: flower: fix possible OOB write in fl_set_geneve_opt()

    Bugzilla: https://bugzilla.redhat.com/2216989
    CVE: CVE-2023-35788
    Y-Commit: 3e8b828793c8d20c03236f37267197bb328dc5e7

    O-Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=2214027
    Upstream Status: net.git commit 4d56304e5827
    O-CVE: CVE-2023-35788

    commit 4d56304e5827c8cc8cc18c75343d283af7c4825c
    Author: Hangyu Hua <hbh25y@gmail.com>
    Date:   Wed May 31 18:28:04 2023 +0800

        net/sched: flower: fix possible OOB write in fl_set_geneve_opt()

        If we send two TCA_FLOWER_KEY_ENC_OPTS_GENEVE packets and their total
        size is 252 bytes(key->enc_opts.len = 252) then
        key->enc_opts.len = opt->length = data_len / 4 = 0 when the third
        TCA_FLOWER_KEY_ENC_OPTS_GENEVE packet enters fl_set_geneve_opt. This
        bypasses the next bounds check and results in an out-of-bounds.

        Fixes: 0a6e77784f49 ("net/sched: allow flower to match tunnel options")
        Signed-off-by: Hangyu Hua <hbh25y@gmail.com>
        Reviewed-by: Simon Horman <simon.horman@corigine.com>
        Reviewed-by: Pieter Jansen van Vuuren <pieter.jansen-van-vuuren@amd.com>
        Link: https://lore.kernel.org/r/20230531102805.27090-1-hbh25y@gmail.com
        Signed-off-by: Paolo Abeni <pabeni@redhat.com>

    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Lucas Zampieri <lzampier@redhat.com>

Signed-off-by: Ryan Sullivan <rysulliv@redhat.com>
---
 net/sched/cls_flower.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/net/sched/cls_flower.c b/net/sched/cls_flower.c
index b81abfcd2a19..ca232483cfab 100644
--- a/net/sched/cls_flower.c
+++ b/net/sched/cls_flower.c
@@ -1151,6 +1151,9 @@ static int fl_set_geneve_opt(const struct nlattr *nla, struct fl_flow_key *key,
 	if (option_len > sizeof(struct geneve_opt))
 		data_len = option_len - sizeof(struct geneve_opt);
 
+	if (key->enc_opts.len > FLOW_DIS_TUN_OPTS_MAX - 4)
+		return -ERANGE;
+
 	opt = (struct geneve_opt *)&key->enc_opts.data[key->enc_opts.len];
 	memset(opt, 0xff, option_len);
 	opt->length = data_len / 4;
-- 
2.40.1


